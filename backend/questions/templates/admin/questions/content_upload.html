{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} | Django Admin{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    .upload-form {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .upload-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    .upload-table th,
    .upload-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
    }
    .upload-table th {
        background-color: #f5f5f5;
        font-weight: bold;
    }
    .status-badge {
        padding: 4px 8px;
        border-radius: 3px;
        color: white;
        font-size: 12px;
        font-weight: bold;
    }
    .status-uploaded { background-color: #17a2b8; }
    .status-validating { background-color: #ffc107; color: #333; }
    .status-valid { background-color: #28a745; }
    .status-invalid { background-color: #dc3545; }
    .status-processing { background-color: #fd7e14; }
    .status-completed { background-color: #6f42c1; }
    .status-failed { background-color: #dc3545; }
    .action-buttons a {
        margin-right: 5px;
        padding: 5px 10px;
        text-decoration: none;
        border-radius: 3px;
        font-size: 12px;
    }
    .btn-process {
        background-color: #28a745;
        color: white;
    }
    .btn-delete {
        background-color: #dc3545;
        color: white;
    }
    .btn-status {
        background-color: #17a2b8;
        color: white;
    }
    .error-message {
        color: #dc3545;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<div class="upload-form">
    <h2>Upload New JSON Content</h2>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="{{ form.file_name.id_for_label }}">{{ form.file_name.label }}:</label>
            {{ form.file_name }}
            {% if form.file_name.errors %}
                <div class="error-message">{{ form.file_name.errors.0 }}</div>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="{{ form.content_type.id_for_label }}">{{ form.content_type.label }}:</label>
            {{ form.content_type }}
            {% if form.content_type.errors %}
                <div class="error-message">{{ form.content_type.errors.0 }}</div>
            {% endif %}
        </div>
        
        <div class="form-group">
            <label for="{{ form.json_file.id_for_label }}">JSON File:</label>
            {{ form.json_file }}
            {% if form.json_file.errors %}
                <div class="error-message">{{ form.json_file.errors.0 }}</div>
            {% endif %}
            <div class="help-text">{{ form.json_file.help_text }}</div>
        </div>
        
        {% if form.non_field_errors %}
            <div class="error-message">
                {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}
        
        <button type="submit" class="btn btn-primary">Upload Content</button>
    </form>
</div>

<h2>Recent Uploads</h2>
<table class="upload-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>File Name</th>
            <th>Content Type</th>
            <th>Status</th>
            <th>Items Count</th>
            <th>Uploaded By</th>
            <th>Created At</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for upload in uploads %}
        <tr>
            <td>{{ upload.id }}</td>
            <td>{{ upload.file_name }}</td>
            <td>{{ upload.get_content_type_display }}</td>
            <td>
                <span class="status-badge status-{{ upload.status }}">
                    {{ upload.get_status_display }}
                </span>
            </td>
            <td>{{ upload.items_imported|default:"-" }}</td>
            <td>{{ upload.uploaded_by.username }}</td>
            <td>{{ upload.uploaded_at|date:"M d, Y H:i" }}</td>
            <td class="action-buttons">
                {% if upload.status == 'valid' %}
                    <a href="{% url 'admin:questions_content_process' upload.id %}" class="btn-process">Process</a>
                {% endif %}
                
                {% if upload.status in 'uploaded,invalid,failed' %}
                    <a href="{% url 'admin:questions_content_delete' upload.id %}" 
                       class="btn-delete"
                       onclick="return confirm('Are you sure you want to delete this upload?')">Delete</a>
                {% endif %}
                
                <a href="{% url 'admin:questions_content_status' upload.id %}" 
                   class="btn-status" target="_blank">Status</a>
            </td>
        </tr>
        {% if upload.error_message %}
        <tr>
            <td colspan="8" class="error-message">
                Error: {{ upload.error_message }}
            </td>
        </tr>
        {% endif %}
        {% empty %}
        <tr>
            <td colspan="8" style="text-align: center; color: #666;">
                No uploads found. Upload your first JSON content file above.
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div style="margin-top: 20px;">
    <h3>Supported JSON Formats</h3>
    <ul>
        <li><strong>Question Bank:</strong> Contains a collection of questions for a specific topic</li>
        <li><strong>Exam:</strong> Complete exam with multiple tests and questions</li>
        <li><strong>Test:</strong> Single test with questions and configuration</li>
        <li><strong>Mixed Content:</strong> Multiple content types in a single file</li>
    </ul>
    
    <p><em>All JSON files are validated against the expected schema before processing.</em></p>
</div>

{% endblock %}